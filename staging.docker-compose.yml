version: "3.4"

services:

  gcloud_datastore:
    build:
      context: .
      dockerfile: gcp/datastore/Dockerfile
      cache_from:
        - "hato-atama-staging-docker-compose-cache-gcloud_datastore"
    tty: true
    environment:
      DATASTORE_PROJECT_ID: app
      DATASTORE_LISTEN_ADDRESS: 0.0.0.0:8081
    image:
      "hato-atama-staging-docker-compose-gcloud_datastore"

  server:
    build:
      context: .
      dockerfile: server/Dockerfile
      cache_from:
        - "hato-atama-staging-docker-compose-cache-server"
    environment:
      PROJECT_ID: app
      DATASTORE_EMULATOR_HOST: "gcloud_datastore:8081"
      PORT: 8082
    ports:
      - 8082:8082
    image:
      "hato-atama-staging-docker-compose-server"

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      cache_from:
        - "hato-atama-staging-docker-compose-cache-frontend"
    ports:
      - 8080:8080
    image:
      "hato-atama-staging-docker-compose-frontend"
